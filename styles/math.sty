%%%%% Packages

% IEEE conference already defines \proof (solve conflicts with amsthm)
\@ifclassloaded{ieeeconf}{\let\proof\relax \let\endproof\relax}{}

\@ifpackageloaded{amsmath}{}{\RequirePackage{amsmath}} % fleqn,tbtags

\@ifpackageloaded{cleveref}{}{\RequirePackage{cleveref}}
\Crefformat{app}{Appendix #2#1#3}
\Crefrangeformat{app}{Appendices #3#1#4 to #5#2#6}
\Crefmultiformat{app}{Appendices #2#1#3}{ and #2#1#3}{, #2#1#3}{ and #2#1#3}
\Crefrangemultiformat{app}{Appendices #3#1#4 to #5#2#6}{ and #3#1#4 to #5#2#6}{, #3#1#4 to #5#2#6}{ and #3#1#4 to #5#2#6}

\@ifpackageloaded{mathtools}{}{\RequirePackage{mathtools}}
\@ifpackageloaded{amsfonts}{}{\RequirePackage{amsfonts}}
% \@ifpackageloaded{amssymb}{}{\RequirePackage{amssymb}}
\@ifpackageloaded{mathcommand}{}{\RequirePackage{mathcommand}}
% \@ifpackageloaded{mathcommand}{}{\RequirePackage{mathrsfs}}
\@ifpackageloaded{nicefrac}{}{\RequirePackage{nicefrac}}

%%%%% Environments

% load amsthm packace and define environments
\@ifclassloaded{beamer}{
        % Do nothing, Beamer defines theorem environments itself.
}
{
        \@ifpackageloaded{amsthm}{}{\RequirePackage{amsthm}}

        \newtheorem{theorem}{Theorem}%[section*]
        \newtheorem*{theorem*}{Theorem}%[section*]
        \newtheorem{proposition}{Proposition}%[section*]
        \newtheorem*{proposition*}{Proposition}%[section*]
        \newtheorem{result}{Result}%[section*]
        \newtheorem*{result*}{Result}%[section*]
        \newtheorem{lemma}{Lemma}%[section*]
        \newtheorem*{lemma*}{Lemma}%[section*]
        \newtheorem{corollary}{Corollary}%[section*]
        \newtheorem*{corollary*}{Corollary}%[section*]
        \newenvironment{definition}[1][Definition.]{\begin{trivlist}
                        \item[\hskip \labelsep {\bfseries #1}]}{\end{trivlist}}
        \newenvironment{example}[1][Example.]{\begin{trivlist}
                        \item[\hskip \labelsep {\bfseries #1}]}{\end{trivlist}}
}
\newtheorem{statement}{Statement}%[section*]
\newenvironment{notation}[1][Notation.]{\begin{trivlist}
                \item[\hskip \labelsep {\bfseries #1}]}{\end{trivlist}}
\newenvironment{remark}[1][Remark.]{\begin{trivlist}
                \item[\hskip \labelsep {\bfseries #1}]}{\end{trivlist}}

\@ifpackageloaded{thm-restate}{}{\RequirePackage{thm-restate}}

%%%%% Operators

% Function support
\DeclareMathOperator{\supp}{supp}

% Spectrum
\DeclareMathOperator{\spec}{spec}

% Condition number
\DeclareMathOperator{\cond}{cond}

% Essential supremum
\DeclareMathOperator{\esup}{ess\,sup}

% Span: \Span X for span X
\DeclareMathOperator{\Span}{span}

% Closure: \clos X for clos X
\DeclareMathOperator{\clos}{clos}

% Gradient: \grad{f} for \nabla f
\DeclareMathOperator{\Grad}{grad}


%%%%% Delimeters

% Routine for creating paired delimiters
\newcommand{\RegisterPairedDelimiter}[3][1]{
        \ifnum#1=1 \newcommand{#2}[2][-1]{%
                        \ifnum##1=-1 #3*{##2}\relax\fi%
                        \ifnum##1=0 #3{##2}\relax\fi%
                        \ifnum##1=1 #3[\big]{##2}\relax\fi%
                        \ifnum##1=2 #3[\Big]{##2}\relax\fi%
                        \ifnum##1=3 #3[\bigg]{##2}\relax\fi%
                        \ifnum##1=4 #3[\Bigg]{##2}\relax\fi%
                }\fi%
        \ifnum#1=2 \newcommand{#2}[3][-1]{%
                        \ifnum##1=-1 #3*{##2}{##3}\relax\fi%
                        \ifnum##1=0 #3{##2}{##3}\relax\fi%
                        \ifnum##1=1 #3[\big]{##2}{##3}\relax\fi%
                        \ifnum##1=2 #3[\Big]{##2}{##3}\relax\fi%
                        \ifnum##1=3 #3[\bigg]{##2}{##3}\relax\fi%
                        \ifnum##1=4 #3[\Bigg]{##2}{##3}\relax\fi%
                }\fi%
}

% Round brackets: \rbr{5} for (5)
\DeclarePairedDelimiter{\rbrdelim}{(}{)}
\RegisterPairedDelimiter{\rbr}{\rbrdelim}

% Square brackets: \sbr{5} for [5]
\DeclarePairedDelimiter{\sbrdelim}{[}{]}
\RegisterPairedDelimiter{\sbr}{\sbrdelim}

% Mixed brackets: \srbr{5} for [5) or \rsbr{5} for (5]
\DeclarePairedDelimiter{\srbrdelim}{[}{)}
\RegisterPairedDelimiter{\srbr}{\srbrdelim}

\DeclarePairedDelimiter{\rsbrdelim}{(}{]}
\RegisterPairedDelimiter{\rsbr}{\rsbrdelim}

% Curl brackets: \cbr{5} for {5}
\DeclarePairedDelimiter{\cbrdelim}{\{}{\}}
\RegisterPairedDelimiter{\cbr}{\cbrdelim}

% Absolute value: \abs{5} for |5|
\DeclarePairedDelimiter{\absdelim}{\lvert}{\rvert}
\RegisterPairedDelimiter{\abs}{\absdelim}

% Norm: \norm{5} for ||5||
\DeclarePairedDelimiter{\normdelim}{\lVert}{\rVert}
\RegisterPairedDelimiter{\norm}{\normdelim}

% Inner product: \innerp{5}{6} for <5,6>
\DeclarePairedDelimiterX{\innerpdelim}[3]{\langle}{\rangle}{#1,#2}
\RegisterPairedDelimiter[2]{\innerp}{\innerpdelim}


%%%%% Shortcuts

% intersection
\let\texthat\^ % redefinition: hat over letter in text
\renewcommand{\^}{\relax\ifmmode\cap\else\expandafter\texthat\fi}

% Cartesian product
\newcommand{\x}{\times}

% vector
\let\textv\v % redefinition: v under letter in text
\renewcommand{\v}{\relax\ifmmode\@ifstar{\expandafter\boldsymbol}{\expandafter\mathbf}\else\expandafter\textv\fi} % not working

% matrix
\newcommand{\m}{\expandafter\mathbf}

% set
\newcommand{\s}{\expandafter\mathcal}

% function
\declaremathcommand{\f}{\expandafter\operatorname}

% Partial derivative
\newcommand{\pd}{\@ifstar{\pdfull}{\pdcontract}}
\newcommand{\pdfull}[2]{\frac{\partial #1}{\partial #2}}
\newcommand{\pdcontract}[2]{\partial_{#2} #1}

% Time derivative
\newcommand{\td}[1]{\dot{#1}}
\newcommand{\tdd}[1]{\ddot{#1}}

% Dataset
\newcommand{\dataset}{{\cal D}}

% Text mode
\let\textt\t
\renewcommand{\t}{\relax\ifmmode\expandafter\text\else\textt\fi}

\let\textP\P % redefinition: paragraph symbol
\DeclareMathOperator{\mathP}{\mathbb{P}} % probability symbol
\renewcommand{\P}{\relax\ifmmode\expandafter\mathP\else\expandafter\textP\fi} % probability
\DeclareMathOperator*{\E}{\mathbb{E}} % expectation
\DeclareMathOperator{\Var}{Var} % variance
\DeclareMathOperator{\Cov}{Cov} % covariance
\DeclareMathOperator{\sgn}{sgn} % sign
\newcommand{\N}{\mathbb{N}} % natural numbers
\newcommand{\Z}{\mathbb{Z}} % integers
\newcommand{\Q}{\mathbb{Q}} % rational numbers
\newcommand{\R}{\mathbb{R}} % real numbers
\let\textC\C
\DeclareMathOperator{\mathC}{\mathbb{C}}
\providecommand{\C}{}
\renewcommand{\C}{\relax\ifmmode\expandafter\mathC\else\expandafter\textC\fi} % complex numbers
\newcommand{\T}{\mathbb{T}} % torus
\newcommand{\eps}{\varepsilon} % epsilon
\newcommand{\dist}[1][]{\sim\ifx\\#1\\\else\operatorname{#1}\fi} % distributed as
\newcommand{\iid}[1][]{\overset{\textrm{iid}}{\sim}\ifx\\#1\\\else\operatorname{#1}\fi} % iid
\newcommand{\notindep}{\mathrel{\hspace*{0.3ex}\not\hspace*{-0.9ex}\rotatebox[origin=c]{90}{$\models$}}} % not independent
\newcommand{\indep}{\mathrel{\rotatebox[origin=c]{90}{$\models$}}} % independent
\newcommand{\given}{\mid} % conditional probability
\let\textu\u % redefinition: underline
\renewcommand{\u}{\relax\ifmmode\cup\else\expandafter\textu\fi} % union
\DeclarePairedDelimiter{\deldelim}{(}{)}
\RegisterPairedDelimiter{\del}{\deldelim}
\newcommand{\bdot}{\mathbin{\vcenter{\hbox{\scalebox{0.5}{\ensuremath{\bullet}}}}}} % big dot binary operation

\let\textc\c % redefinition: v under letter in text
\renewcommand{\c}{\relax\ifmmode\expandafter\mathcal\else\expandafter\textc\fi} % calligraphic

\let\textd\d %redefinition: dot under letter in text
\renewcommand{\d}{\relax\ifmmode\mathop{}\!\mathrm{d}\else\expandafter\textd\fi} % differental

\declaremathcommand{\f}{\expandafter\operatorname} % function

\newif\ifenvironments@nonumber
\DeclareOption{nonumber}{\environments@nonumbertrue}

\ProcessOptions\relax
\ifenvironments@nonumber
% \renewcommand{\[}{\begin{equation*}}
% \renewcommand{\]}{\end{equation*}}
\def\[#1\]{\in@{\label}{#1}\ifin@\in@{&}{#1}\ifin@\begin{align}#1\end{align}\else\in@{\\}{#1}\ifin@\begin{gather}#1\end{gather}\else\begin{equation}#1\end{equation}\fi\fi\else\in@{&}{#1}\ifin@\begin{align*}#1\end{align*}\else\in@{\\}{#1}\ifin@\begin{gather*}#1\end{gather*}\else\begin{equation*}#1\end{equation*}\fi\fi\fi}
\def\<#1\>{\in@{\label}{#1}\ifin@\begin{align}#1\end{align}\else\begin{align*}#1\end{align*}\fi}
\def\?#1\?{\in@{\label}{#1}\ifin@\begin{gather}#1\end{gather}\else\begin{gather*}#1\end{gather*}\fi}
\else
% \renewcommand{\[}{\begin{equation}}
% \renewcommand{\]}{\end{equation}}
\def\[#1\]{\in@{&}{#1}\ifin@\begin{align}#1\end{align}\else\in@{\\}{#1}\ifin@\begin{gather}#1\end{gather}\else\begin{equation}#1\end{equation}\fi\fi}
\def\<#1\>{\begin{align}#1\end{align}}
\def\?#1\?{\begin{gather}#1\end{gather}}
\fi

\DeclareMathOperator*{\argmin}{\arg\min} % argmin
\DeclareMathOperator*{\argmax}{\arg\max} % argmax
\DeclareMathOperator{\tr}{tr}